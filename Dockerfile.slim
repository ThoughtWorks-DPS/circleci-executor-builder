FROM twdps/circleci-base-image:slim-3.1.0

LABEL maintainer=<nchenewe@thoughtworks.com>

ENV CONFTEST_VERSION=0.27.0

ENV DEBIAN_FRONTEND=noninteractive
SHELL ["/bin/bash", "-exo", "pipefail", "-c"]

# hadolint ignore=DL4001,DL3004,DL3047
RUN sudo bash -c "echo 'APT::Get::Assume-Yes \"true\";' > /etc/apt/apt.conf.d/90circleci" && \
    sudo bash -c "echo 'DPkg::Options \"--force-confnew\";' >> /etc/apt/apt.conf.d/90circleci" && sudo apt-get update && \
    sudo apt-get install --no-install-recommends -y \
            curl=7.74.0-1.3+b1 \
            wget=1.21-1+b1 \
            gnupg=2.2.27-2 \
            apt-transport-https=2.3.8 \
            lsb-release=11.1.0 \
            ruby-full=1:2.7+2 \
            gcc=4:10.2.1-1 \
            g++=4:10.2.1-1 \
            make=4.3-4.1 \
            gnupg && \
    sudo bash -c "curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg" && \
    sudo bash -c "echo \"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable\" | tee /etc/apt/sources.list.d/docker.list > /dev/null" && sudo apt-get update && \
    sudo apt-get install --no-install-recommends -y \        
                 docker-ce=5:20.10.8~3-0~debian-bullseye \
                 docker-ce-cli=5:20.10.8~3-0~debian-bullseye \
                 containerd.io=1.4.9-1 && \
    sudo bash -c "curl -sL https://deb.nodesource.com/setup_14.x | bash - " && \
    sudo apt-get install --no-install-recommends -y \
                 nodejs=14.17.5-deb-1nodesource1 && \
    sudo apt-get clean && \
    sudo rm -rf /var/lib/apt/lists/* && \
    sudo bash -c "sed -i 's/^# *\(en_US.UTF-8\)/\1/' /etc/locale.gen && locale-gen" && \
    sudo npm install -g \
             snyk@1.692.0 \
             bats@1.4.1 && \
    sudo gem install --no-document \
             inspec-bin:4.41.2 && \
    wget https://github.com/open-policy-agent/conftest/releases/download/v${CONFTEST_VERSION}/conftest_${CONFTEST_VERSION}_Linux_x86_64.tar.gz && \
    tar xzf conftest_${CONFTEST_VERSION}_Linux_x86_64.tar.gz && \
    sudo apt remove -y gnupg && \
    sudo mv conftest /usr/local/bin && sudo rm conftest*

COPY inspec /etc/chef/accepted_licenses/inspec

USER circleci

WORKDIR /home/circleci/project
